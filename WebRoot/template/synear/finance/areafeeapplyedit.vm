<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>======</title>
<script src="../../../js/sunnyfunc.js"></script>
<script>
var submitok=false;
var ChosedList=new Array();
var header=9;		//定单头的个数
var thisCol=5;	//表单体的列数
var others=0;		//表单中非表单体的控件数
var thisRow=10;     //初始行数
var submitok=false; //是否已提交
var testRow=-1;     //验证数据行号
var row=thisRow;
var submitfirst=true;
var undefined;
var seleRow=0;
   var datatb;
var data=new Array();//单个记录元素数据数组
//一维数组赋值     
function data1()
{
	var data=new Array()
	args=data1.arguments;
	for(i=0;i<args.length;i++)
	{
	  data[i]=args[i];
	}
	return data;
}
     
//二维数组赋值     
function data2(data)
{
	this.data=data;
}

var bData1=new Array(); 
   data=new data1('产品主键','产品类别','类别代码');
   bData1[0]=new data2(data);
 #set($i=1)
 #foreach($m in $getProductClass)
   data=new data1('$m.PK_INVCL','$m.INVCLASSNAME','$m.INVCLASSCODE');
   bData1[$i]=new data2(data);
   #set($i=$i+1)
 #end

/**
*在行上聚焦和失焦
**/
function MouseOver(i){
   for(j=0;j<i.cells.length;j++){
       i.cells[j].style.backgroundColor='#e9e9e9'; i.cells[j].style.cursor='hand';
   }
}
function MouseOut(i){
   for(j=0;j<i.cells.length;j++){
       i.cells[j].style.backgroundColor='#FFFFFF';
   }
}

function addListener() {
 var inputList = document.body.getElementsByTagName("INPUT");
 if(inputList[0]) firstInput = inputList[0];
    for(var i=0;i<inputList.length;i++) {
      inputList[i].attachEvent ('onfocus', onInputFocus);
   }
}

function onInputFocus(){
     for(i=0;i<dtb.length;i++)
       tb.rows[i*2+2].style.display="none";
}


function addRow() 
{  
     var tempR=document.all.tb.insertRow();
	 tempR.bgcolor="#FFFFFF";
	 var temp1=tempR.insertCell();	
	 var temp2=tempR.insertCell();	
	 var temp3=tempR.insertCell();	
	 var temp4=tempR.insertCell();	

	 temp1.innerHTML="<input name='F_prodName' type='text' style='width:180' class='login3' onKeyUp=\"showdata(this,"+row+")\"><input name=\"F_prodpk\" type=\"hidden\" value=\"\">";   
	 temp2.innerHTML="<p align=\"center\"><select name=\"F_deptcode\"> #foreach($m in $getCustomerDept)  <option value=\"$m.DEPTCODE\" selected>$m.DEPTNAME</option>   #end  <option value=\"0305\">市场部&nbsp;&nbsp;</option> </select>";
	 temp3.innerHTML="<p align=\"center\"><input name='F_pfee' style='width:120' class='login3' type='text' onKeyUp=\"toNext("+row+")\" >";
	 temp4.innerHTML="<p align=\"center\"><input name='F_pmemo' class='login3' style='width:480' type='text' onKeyUp=\"toNext("+row+")\">";
         document.form1.elements[row*thisCol+header].focus();
	 row=row+1;
     tempR=document.all.tb.insertRow();
     temp1=tempR.insertCell(); 
     temp1.innerHTML="<table id=\"dtb\"></table>";
     temp1.colSpan=8; 
}

function getdata(i,k) { //v6.0
  document.form1.elements[thisCol*k+header].value=bData1[i].data[1];
  document.form1.elements[thisCol*k+header+1].value=bData1[i].data[0];
  tb.rows[k*2+2].style.display="none";
  document.form1.elements[k*thisCol+header+2].focus();
}

function hidetr(k) { //v6.0
    tb.rows[k*2+2].style.display="none";
}


function showdata(obj,k)
{
   key=event.keyCode;
   if(key==40)   //向下箭头
   {
      try{
        MouseOut(datatb.rows[seleRow]);
        if(seleRow==(datatb.rows.length-1))
          seleRow=1;
        else
          seleRow++;
        MouseOver(datatb.rows[seleRow]);
      }catch(e){}
   }else if(key==38)   //向上箭头
   {
      try{
        MouseOut(datatb.rows[seleRow]);
        if(seleRow==1)
          seleRow=(datatb.rows.length-1);
        else
          seleRow--;
        MouseOver(datatb.rows[seleRow]);
      }catch(e){}
   }else if(key==13 && tb.rows[k*2+2].style.display!="none")      //回车
   {
     try{
       datatb.rows[seleRow].onclick();
     }catch(e){}
   }
   else{
      var str="";
      var zcode=obj.value;
      var slen=0
      slen=zcode.length;
      var mm=0;
      for(i=0;i<bData1.length;i++)
      {
        if((bData1[i].data[1].indexOf(zcode)>-1) && zcode!="")
        {
             str+="<tr class=\"fCopy\" onMouseOver=\"MouseOut(datatb.rows[seleRow]);seleRow=this.rowIndex;MouseOver(this);\" onMouseOut=\"MouseOut(datatb.rows[seleRow]);seleRow=1;MouseOut(this);\" onclick=\"getdata("+i+","+k+")\"><td>"+bData1[i].data[0]+"</td><td>"+bData1[i].data[1]+"</td><td>"+bData1[i].data[2]+"</td></tr>";
             mm++;
        }
      }
      if(zcode=="")
      {
		document.form1.elements[k*thisCol+header].value="";
		document.form1.elements[k*thisCol+header+1].value="";
		document.form1.elements[k*thisCol+header+3].value="";
		document.form1.elements[k*thisCol+header+4].value="";
		allfee();
      }
      if(str!="")
      {
        str="<tr class=\"fCopy\" onclick=\"hidetr("+k+")\"><td>"+bData1[0].data[0]+"</td><td>"+bData1[0].data[1]+"</td><td>"+bData1[0].data[2]+"</td></tr>"+str;
        str="<table id=\"dtb\">"+str+"</table>";
        tb.rows[k*2+2].style.display="";
        tb.rows[k*2+2].cells[0].innerHTML="<span>"+str+"</span>";
        
        datatb=dtb[k];
        try{
          MouseOver(datatb.rows[1]);
        }catch(e){}
        seleRow=1;
      }
      else
        tb.rows[k*2+2].style.display="none";
    }
}

function init()
{
    addListener();
}

function ShowDate(idText){
 var state="dialogHeight: 300px; dialogWidth: 240px; dialogTop: 200px; dialogLeft: 300px; "+             "edge: Raised;  center: Yes; help: No; resizable: Yes; status: No;";

 var reValue=window.showModalDialog('../../../js/date.html?OpenForm',"myDate",state);
 if(reValue==null) 
   ;
 else
   idText.value=reValue;
 
 }

function toNext(i)
{
   var elms=event.srcElement;
   key=event.keyCode;
   if(key==13)   //回车
   {
      if(elms.name=="F_prodName")
        document.form1.F_pfee[i].focus(); 
      else if(elms.name=="F_pfee")
        document.form1.F_pmemo[i].focus(); 
      else if(elms.name=="F_pmemo")
      {
        if(i<(row-1))
          document.form1.elements[(i+1)*thisCol+header].focus();
        else
          addRow();
      }
   }else{
      if(elms.name=="F_pfee"){
	   if(isNaN(elms.value))
           { 
              alert("费用必须为数字");
              return;
           } 
	   else
              allfee();
      }
   }
}

function allfee() 
{
   var pfee=0;
   var afee=0;
   try{
	   for(i=0;i<row;i++){
	     if(form1.F_prodpk[i].value!="" && form1.F_pfee[i].value!=""){
		if(!isNaN(form1.F_pfee[i].value)){
		  pfee=pfee+parseFloat(form1.F_pfee[i].value);
		}
	     }
	   }
   }catch(e){}
   if(!isNaN(form1.F_endfee.value)){
       if(form1.F_endfee.value!="") afee=afee+parseFloat(form1.F_endfee.value);
   }
   else
   { 
        alert("费用必须为数字");
        return;
   } 
   if(!isNaN(form1.F_returnfee.value)){
	if(form1.F_returnfee.value!="")  afee=afee+parseFloat(form1.F_returnfee.value);
   }
   else
   { 
        alert("费用必须为数字");
        return;
   } 
   afee=afee+pfee;
   document.all.F_allprodfee.innerText=pfee;
   form1.F_prodfee.value=pfee;
   document.all.F_allfee.innerText=afee;
   form1.F_allfee2.value=afee;
}

function spellStr() 
{

   var str="";
   var spell_sql="";
    if(this.form1.F_endfee.value==""){
       //alert("终端费用不能为空！！！");
       //return false;
       this.form1.F_endfee.value=0;
    }
    if(this.form1.F_returnfee.value==""){
       this.form1.F_returnfee.value=0;
    }
   var b_sql="";
   try{
	   for(i=0;i<row;i++){
		if(form1.F_pfee[i].value=="") form1.F_pfee[i].value=0;
		//if(form1.F_prodpk[i].value=="") form1.F_prodpk[i].value=i;
		if(form1.F_prodpk[i].value!="" && form1.F_pfee[i].value!=""){
		   if(str.indexOf("!"+this.form1.F_prodpk[i].value+"A"+this.form1.F_deptcode[i].value)!=-1){
			alert("费用重复！！！");
			document.form1.elements[i*thisCol+header+0].value="";
			document.form1.elements[i*thisCol+header+1].value="";
			document.form1.elements[i*thisCol+header+3].value="";
			document.form1.elements[i*thisCol+header+4].value="";
			document.form1.elements[i*thisCol+header+0].focus();
			return false;
		   }

		   if(isNaN(form1.F_pfee[i].value))
		   { 
		      alert("费用必须为数字");
		      form1.F_pfee[i].focus();
		      return;
		   }  
		   b_sql="have";
		   str=str+"!"+this.form1.F_prodpk[i].value+"A"+this.form1.F_deptcode[i].value;
		}
	    }
	    /*if(b_sql==""){
		  alert("您没有录入费用，请录入！！！");
		  return false;
	    }*/
  }catch(e){}
  allfee();
  this.form1.action='areaFeeApply_edit.aspx';
  this.form1.target='dataframe';
  if(!submitok)
  {
      submitok=true;
      this.form1.submit();
  }else{
      alert("请不要确认两次！");
	  return;
  }
}

</script>
<link href="../../../css.css" rel="stylesheet" type="text/css">
</head>
<body onload="init()">
<br>
<table width="700" height="30"  border="0" align="center" cellpadding="0" cellspacing="0" class="B1">
  <tr>
    <td class="f">&nbsp;&nbsp; <div align="center" class="style1">客户费用申请表</div></td>
  </tr>
</table>
<table width="90%"  border="0" align="center" cellpadding="0" cellspacing="0">
<tr><td height="30" class="fCopy" id="help"></td></tr>
</table>
<form name="form1" method='post' action="">  
<table width="90%" border="0" align="center" cellpadding="0" cellspacing="1" bgcolor="#999999">
#foreach($m in $getEditAreaFeeApply)
  <tr bgcolor="#E3E3E3" class="fCopy">
    <td height="24" nowrap><div align="right">申请时间：</div></td>
    <td width="294" height="25" nowrap>$m.APPLYMONTH <input name="F_month" type="hidden" value="$!m.APPLYMONTH"></td>
    <td width="140" height="25" nowrap><div align="right">客户名称：</div></td>
    <td width="243" height="25" nowrap>  $!m.CUSTNAME
     <input name="F_custpk" type="hidden" class="login" id="F_custpk" value="$form_custpk">
    </td>
  </tr>
  <tr id="corptr" bgcolor="#ffffff"><td colspan=8 style="padding:0px" ><table id="corpdtb"></table></td></tr>
  <tr bgcolor="#E3E3E3" class="fCopy">
	<td width="140" height="25" nowrap><div align="right">预算终端费用：</div></td>
	<td width="243" height="25" nowrap > 
	 <div align="left">     
	    <input name="F_endfee" type="text" class="login" id="F_endfee"  style="width:200 " value="$!m.PRE_ENDFEE" onKeyUp="allfee()">*
      </div></td>
      <td width="140" height="25"  nowrap><div align="right">预算返利：</div></td>
	<td width="243" height="25" nowrap> 
	 <div align="left">     
	    <input name="F_returnfee" type="text" class="login" id="F_returnfee"  style="width:200 " value="$!m.PRE_RETURN"  onKeyUp="allfee()">
      </div></td>
  </tr>
  <tr bgcolor="#E3E3E3" class="fCopy">
	<td width="140" height="25" nowrap><div align="right">预算产品费用：</div></td>
	<td width="243" height="25"  nowrap>
	 <div align="left" id="F_allprodfee">$!m.PRE_PRODFEE</div></td>
      <td width="140" height="25" nowrap><div align="right">预算费用合计：</div></td>
	<td width="243" height="25"  nowrap>
	 <div align="left" id="F_allfee">$!m.PRE_ALLFEE</div></td>
  </tr>
  <tr bgcolor="#E3E3E3" class="fCopy">
    <td height="51%" nowrap>
    <div align="right">预算备注：</div></td>
    <td height="60" colspan="3" nowrap>
    <textarea name="F_memo" cols="80" rows="2">$!m.REMARK</textarea>
    <input name="F_id" type="hidden" value="$!m.FEEID">
    <input name="F_prodfee" type="hidden" value="$!m.PRE_PRODFEE"><input name="F_allfee2" type="hidden" value="$!m.PRE_ALLFEE">
    </td>
  </tr>
#end
            #foreach($mm in $getCustomerDept)
               <input name="areacode" type="hidden" value="$mm.DEPTCODE">
            #end
</table>
<br>
<table id="tb" width="90%" border="1" align="center" cellpadding="0" cellspacing="1" bordercolor="#D4D0C8" bgcolor="#FFFFFF">
  <tr bgcolor="#E3E3E3" class="fCopy">
    <th width="16%" height="25" nowrap class="fCopy">产品类别</th>
    <th width="8%" height="25" nowrap class="fCopy">部门名称</th>
    <th width="10%" height="25" nowrap class="fCopy">预算费用金额</th>
    <th width="38%" height="25" nowrap class="fCopy">备注</th>
  </tr>
  <tr bgcolor="#FFFFFF" style="display:none">
     <td align="center" nowrap><input name="F_prodName" value="" type="text"  style="width:180" class='login3' onKeyUp="showdata(this,0)">
     <input name="F_prodpk" type="hidden" value="">	 </td>
      <td align="center" nowrap>
        <select name="F_deptcode" id="F_deptcode0">
            <option value="0305">市场部&nbsp;&nbsp;</option>
        </select>
      </td>
      <td align="center" nowrap><input name="F_pfee" value="" type="text" class="login3" style="width:120" onKeyUp="toNext(0)"></td>
        <td align="center" nowrap><input name="F_pmemo" value="" type="text" class="login3" style="width:480" onKeyUp="toNext(0)"></td>
  </tr>
  <tr><td colspan=8 style="padding:0px" ><table id="dtb"></table></td></tr>
  #set($i=1)
  #foreach($m in $getEditAreaFeeApply2)
  <tr bgcolor="#FFFFFF" class="fCopy">
     <td align="center" nowrap><input name="F_prodName" value="$!m.INVCLASSNAME" type="text"  style="width:180" class='login3' onKeyUp="showdata(this,$i)">
     <input name="F_prodpk" type="hidden" value="$!m.PRODUCT_CLS_CODE">	 </td>
      <td align="center" nowrap>
        <select name="F_deptcode">
            #foreach($mm in $getCustomerDept)
               <option value="$mm.DEPTCODE">$mm.DEPTNAME</option>
            #end
            <option value="0305">市场部&nbsp;&nbsp;</option>
        </select>
      </td>
      <script>document.all.F_deptcode[$i].value="$m.AREACODE"</script>
      <td align="center" nowrap><input name="F_pfee" value="$m.PRE_PRODUCTFEE" type="text" class="login3" style="width:120" onKeyUp="toNext($i)"></td>
        <td align="center" nowrap><input name="F_pmemo" value="$m.REMARK" type="text" class="login3" style="width:480" onKeyUp="toNext($i)"></td>
  </tr>
  <tr><td colspan=8 style="padding:0px" ><table id="dtb"></table></td></tr>
  #set($i=$i+1)
 #end
 <script>thisRow=$i; row=$i</script>
  </table>

   <div align="center">
  <input type="button" class="login2" value=" 保  存 " name="B22" onClick="spellStr();">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<input type="button" class="login2" value=" 添加行 " name="B222" onClick="addRow();">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<input type="button" class="login2" value=" 返  回 " name="B222" onClick="history.go(-1);">
  </div>
</form>
<iframe name="dataframe" src="" width="0" height="0"></iframe>

</body> 
</html>      
