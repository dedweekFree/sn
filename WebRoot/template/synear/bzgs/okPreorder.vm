<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<script language="javaScript" src="../../../js/common.js"></script>
<script language="javaScript" src="../../../js/funbase.js"></script>
<script language="JavaScript" src="../../../js/sunnysoft.js"></script>
<script language="JavaScript" src="../../../js/sunnyfunc.js"></script>
<script language="JavaScript" src="../../../js/browers.js"></script>
<script language="JavaScript" src="../../../js/formCheck.js"></script>
<title>===销售计划===</title>
<script language="javascript" src="../../../js/custOkGridEdit.js"></script>
<style type="text/css">
<!--
body,div,p,ul,li,font,span,td,th{
font-size:10pt;
line-height:155%;
}
table{
border-top-width: 1px;
border-right-width: 1px;
border-bottom-width: 0px;
border-left-width: 1px;
border-top-style: solid;
border-right-style: solid;
border-bottom-style: none;
border-left-style: solid;
border-top-color: #CCCCCC;
border-right-color: #CCCCCC;
border-bottom-color: #CCCCCC;
border-left-color: #CCCCCC;
}
td{
border-bottom-width: 1px;
border-bottom-style: solid;
border-bottom-color: #CCCCCC;
}
.EditCell_TextBox {
width: 90%;
border:1px solid #0099CC;
}
.EditCell_DropDownList {
width: 90%;
}
.dirty-cell {
    background: transparent url(../../../images/dirty.gif) no-repeat 0 0;
}
.fixedHeaderTr    
{    
position:relative;    
top:expression(this.offsetParent.scrollTop-3);    
};    
   
.mainDiv    
{    
overflow:auto;    
scrollbar-face-color:9999ff; 
height:expression((document.body.clientHeight-this.offsetTop-20>this.children[0].offsetHeight)?(this.children[0].offsetHeight+20)   :   (document.body.clientHeight-this.offsetTop-20));    
width:expression((document.body.clientWidth-this.offsetLeft));   
}
-->
</style>

</head>
<script>
//width:expression(document.body.clientWidth-20);  
var bData1=new Array(); 

bData1=[
      ['产品代码','产品名称','产品规格','下单量','按排量','备货量','发货量','实收量','状态','nc主键','0','新鲜度v','质量v','新鲜度t','质量t']
 #set($i=1)
 #foreach($m in $getPreOrderDetailsOk)
      ,['$m.INVCODE','$m.INVNAME','$m.INVSPEC','$m.PREORDERNUM','$m.ARRNUM','$m.ORDERNUM','$m.SALENUM','$m.NNUMBER','$m.FLAG','$m.PK_INVBASDOC','$i','$m.XXD','$m.QUANTITY','$m.XXD','$m.QUANTITY']
   #set($i=$i+1)
 #end
]
var pageSize=50;
var pageno=0;
var rdata=new Array();
rdata=bData1;

function toPage2() 
{
  var element=document.all.pgs;
  if(element.value.search("^-?\\d+(\\.\\d+)?$")!=0){
     alert("页数必须为大于1且小于"+Math.ceil((rdata.length-1)/pageSize)+"的整数!");
     element.focus();
     return false;
  }
  if(element.value<1){
     alert("页数必须为大于1且小于"+Math.ceil((rdata.length-1)/pageSize)+"的整数!");
     element.focus();
     return false;
  }
  if(element.value>Math.ceil((rdata.length-1)/pageSize)){
     alert("页数必须为大于1且小于"+Math.ceil((rdata.length-1)/pageSize)+"的整数!");
     element.focus();
     return false;
  }
  toPage(element.value) 
}

function toPage(page) 
{
try{
  savepage(pageno);
  pageno=page;
  for(var i=table6.rows.length;i>1;i--) table6.deleteRow(i-1);
  for(var i=1;i<=pageSize;i++){
    if(((page-1)*pageSize+i)<rdata.length){
  	  var row=table6.insertRow()
	  if(rdata[(page-1)*pageSize+i][8]=='Y') row.insertCell().innerHTML="<input type=checkbox name=checkbox value='checkbox'  onclick='allPlan()' checked>";
	  else{
	     row.insertCell().innerHTML="<input type=checkbox name=checkbox value='checkbox'>";
	  }
	  row.insertCell().innerText=rdata[(page-1)*pageSize+i][0]
	  row.insertCell().innerText=rdata[(page-1)*pageSize+i][1]
	  row.insertCell().innerText=rdata[(page-1)*pageSize+i][2]
	  row.insertCell().innerText=rdata[(page-1)*pageSize+i][3]
	  row.insertCell().innerText=rdata[(page-1)*pageSize+i][6]
	  row.insertCell().innerText=rdata[(page-1)*pageSize+i][7]
	  if(rdata[(page-1)*pageSize+i][7]!=rdata[(page-1)*pageSize+i][6]){
		 className="dirty-cell";
	  }
	  for(var j=11;j<13;j++){
	     with (row.insertCell())
             {
	       innerHTML=rdata[(page-1)*pageSize+i][j+2];
	       setAttribute("Value",rdata[(page-1)*pageSize+i][j]);
	     }
	 }
	 SetRowCanEdit(row);
    }
 }
 // ['产品代码','产品名称','产品规格','下单量','按排量','备货量','发货量','实收量','状态','nc主键','0','新鲜度','质量']
 var apg=Math.ceil((rdata.length-1)/pageSize);
 var npg=parseInt(page)+1;
 var ppg=parseInt(page)-1;
 var pagetext="共<font color=red>"+apg+"</font>页<font color=red>"+(rdata.length-1)+"</font>条记录，每页显示<font color=red>"+pageSize+"</font>条，目前是第<font color=red>"+page+"</font>页&nbsp;&nbsp;&nbsp;&nbsp;";
 if(page<apg) pagetext+="<a style='cursor:hand' onclick='toPage2()'><font color=blue>转到</font></a><input type=text id=pgs size=3 value="+npg+">&nbsp;&nbsp;&nbsp;&nbsp;";
 else  pagetext+="<a style='cursor:hand' onclick='toPage2()'><font color=blue>转到</font></a><input type=text id=pgs size=3 value=1>&nbsp;&nbsp;&nbsp;&nbsp;";
 if(page>1) pagetext+="<a style='cursor:hand' onclick='toPage(1)'><font color=blue>首页</font></a>&nbsp;&nbsp;<a style='cursor:hand' onclick='toPage("+ppg+")'><font color=blue>上一页</font></a>&nbsp;&nbsp;"
 if(page<apg) pagetext+="<a style='cursor:hand' onclick='toPage("+npg+")'><font color=blue>下一页</font></a>&nbsp;&nbsp;<a style='cursor:hand' onclick='toPage("+apg+")'><font color=blue>尾页</font></a>&nbsp;&nbsp;"
 
 document.all.pg.innerHTML=pagetext;
 }catch(e){
   alert(e.description)
 }
}

function search()
{
  savepage(pageno);
  pageno=0;
  var m=1;
  var bname=true;
  var badd=true;
  var bstatus=true;
  rdata=new Array();
  rdata[0]=bData1[0];
  for(var i=1;i<bData1.length;i++){
    bname=form2.elements[0].value==""?true:(bData1[i][0].indexOf(form2.elements[0].value)>-1);
    badd=form2.elements[1].value==""?true:(bData1[i][1].indexOf(form2.elements[1].value)>-1);
    if(form2.elements[2].value=="O")
        bstatus=(bData1[i][3]>0);
    else
	bstatus=form2.elements[2].value=="all"?true:(bData1[i][8]==form2.elements[2].value);
	//alert(bstatus)
    if(bname && badd && bstatus){
       rdata[m]=bData1[i];
	   m++
	}
 }
 toPage(1);
}

function save(step,status)
{
 if(document.all.billdate.value==''){
   alert("收货时间不能为空！");
   return false;
 }
  savepage(pageno);
  var datahtml="";
  var num=0;
  var nextnum=0;
  for(var i=0;i<bData1.length;i++){
    if(bData1[i][3]>0 || bData1[i][6]>0){
       datahtml+="<input type=hidden name=prodpk value='"+bData1[i][9]+"'>";
       datahtml+="<input type=hidden name=prenum value='"+bData1[i][3]+"'>";
       datahtml+="<input type=hidden name=arrnum value='"+bData1[i][4]+"'>";
       datahtml+="<input type=hidden name=ordnum value='"+bData1[i][5]+"'>";
       datahtml+="<input type=hidden name=salenum value='"+bData1[i][6]+"'>";
       datahtml+="<input type=hidden name=realnum value='"+bData1[i][7]+"'>";
       datahtml+="<input type=hidden name=xxd value='"+bData1[i][11]+"'>";
       datahtml+="<input type=hidden name=qty value='"+bData1[i][12]+"'>";
    }
    else if(bData1[i][8]=='Y' && bData1[i][7]>0){
       datahtml+="<input type=hidden name=prodpk value='"+bData1[i][9]+"'>";
       datahtml+="<input type=hidden name=prenum value='"+bData1[i][3]+"'>";
       datahtml+="<input type=hidden name=arrnum value='"+bData1[i][4]+"'>";
       datahtml+="<input type=hidden name=ordnum value='"+bData1[i][5]+"'>";
       datahtml+="<input type=hidden name=salenum value='"+bData1[i][6]+"'>";
       datahtml+="<input type=hidden name=realnum value='"+bData1[i][7]+"'>";
       datahtml+="<input type=hidden name=xxd value='"+bData1[i][11]+"'>";
       datahtml+="<input type=hidden name=qty value='"+bData1[i][12]+"'>";
    }
 }
 if(datahtml==''){
   alert("没有可更新的数据！");
   return false;
 }

 datahtml+="<input type=hidden name=billno value='$form_billno'>";
 datahtml+="<input type=hidden name=billdate value='"+document.all.billdate.value+"'>";
// alert("<input type=hidden name=billdate value='"+document.all.billdate.value+"'>");
 datahtml+="<input type=hidden name=memo value='"+document.all.remark.value+"'>";
 datahtml+="<input type=hidden name=fstatus value='"+status+"'>";

 subdata.innerHTML=datahtml;
 form_submit.action="okPreorderSubmit.aspx";
 form_submit.submit();
}

function savepage(page)
{
  if(page>0){
    for(var i=1;i<table6.rows.length;i++){
      if(document.all.checkbox[i].checked) rdata[(page-1)*pageSize+i][8]='Y';
      else  rdata[(page-1)*pageSize+i][8]='N';
	if(table6.rows[i].cells[6].innerText==""){
	  rdata[(page-1)*pageSize+i][7]=document.all.editbox.value;
	}
	else{
	  rdata[(page-1)*pageSize+i][7]=table6.rows[i].cells[6].innerText;
	}
	if(table6.rows[i].cells[7].innerText==""){
	  rdata[(page-1)*pageSize+i][11]=document.all.selectbox.value;
	  rdata[(page-1)*pageSize+i][13]=document.all.selectbox.options[document.all.selectbox.selectedIndex].text;
	}
	else{
	  rdata[(page-1)*pageSize+i][11]=table6.rows[i].cells[7].getAttribute("Value");
	  rdata[(page-1)*pageSize+i][13]=table6.rows[i].cells[7].innerText;
	}
	if(table6.rows[i].cells[8].innerText==""){
	  rdata[(page-1)*pageSize+i][12]=document.all.selectbox.value;
	  rdata[(page-1)*pageSize+i][14]=document.all.selectbox.options[document.all.selectbox.selectedIndex].text;
	}
	else{
	  rdata[(page-1)*pageSize+i][12]=table6.rows[i].cells[8].getAttribute("Value");
	  rdata[(page-1)*pageSize+i][14]=table6.rows[i].cells[8].innerText;
	}
      bData1[rdata[(page-1)*pageSize+i][10]]=rdata[(page-1)*pageSize+i];
    }
  }
}
function presearch()
{
   key=event.keyCode;
   if(key==13)   //回车
   {
     search();
   }
}

function seldata(obj)
{
  for(var i=1;i<table6.rows.length;i++){
      document.all.checkbox[i].checked=obj.checked
  }
}

function document.onkeydown(){
   key=event.keyCode;
   if(key==83 && event.ctrlKey){
    save();
    return;
   }
   if(key==38)   //向上箭头
   {
     if(event.srcElement.className=="EditCell_TextBox"){
        var ly=event.srcElement.parentNode.offsetTop;
	var hy=mdiv.scrollTop;
	if(ly>hy && (ly-hy<2*ftr.offsetHeight)) mdiv.scrollTop=mdiv.scrollTop-ftr.offsetHeight*2; 
  	//window.status=event.y+","+mdiv.offsetTop;
	//form2.elements[0].value=ftr.offsetHeight;
     }
     return;
   }
   if(key==34)   //page down
   {
     if(event.srcElement.className=="EditCell_TextBox"){
	      var dataType = event.srcElement.parentNode.parentNode.parentNode.rows[0].cells[event.srcElement.parentNode.cellIndex].getAttribute("DataType");
	      switch(dataType){
	      case "Float":
		 if(event.srcElement.value.search("^-?\\d+(\\.\\d+)?$")!=0){
		    return false;
		 }
		 break;
	      case "Number":
		 if(event.srcElement.value.search("^-?\\d+(\\.\\d+)?$")!=0){
		    return false;
		 }
		 break;
	      case "Int":
		 if(event.srcElement.value.search("^-?\\d+$")!=0){
		    return false;
		 }
		 break;
	      case "Email":
		 if(event.srcElement.value.search("^(?:\\w+\\.?)*\\w+@(?:\\w+\\.?)*\\w+$")!=0){
		    return false;
		 }
		 break;
	      default:
		break;
	    }
        if(pageno<Math.ceil((rdata.length-1)/pageSize)){
	  toPage(pageno+1);
	}
     }else{
        if(pageno<Math.ceil((rdata.length-1)/pageSize)){
	  toPage(pageno+1);
	}
     }
     return;
   }
   if(key==33)   //page up
   {
     if(event.srcElement.className=="EditCell_TextBox"){
	      var dataType = event.srcElement.parentNode.parentNode.parentNode.rows[0].cells[event.srcElement.parentNode.cellIndex].getAttribute("DataType");
	      switch(dataType){
	      case "Float":
		 if(event.srcElement.value.search("^-?\\d+(\\.\\d+)?$")!=0){
		    return false;
		 }
		 break;
	      case "Number":
		 if(event.srcElement.value.search("^-?\\d+(\\.\\d+)?$")!=0){
		    return false;
		 }
		 break;
	      case "Int":
		 if(event.srcElement.value.search("^-?\\d+$")!=0){
		    return false;
		 }
		 break;
	      case "Email":
		 if(event.srcElement.value.search("^(?:\\w+\\.?)*\\w+@(?:\\w+\\.?)*\\w+$")!=0){
		    return false;
		 }
		 break;
	      default:
		break;
	    }
        if(pageno>1){
	  toPage(pageno-1);
	}
     }else{
        if(pageno>1){
	  toPage(pageno-1);
	}
     }
   }
   return;
}

function init()     
{  
   form2.elements[2].value='Y';
   search();
   allPlan();
}

function allPlan()
{
  var num=0;
  var nextnum=0;
  savepage(pageno);
  for(var i=1;i<bData1.length;i++){
    num+=parseInt(bData1[i][6]);
    if(bData1[i][8]=='Y'){
       nextnum+=parseInt(bData1[i][7]);
    }
  }
  document.all.yssl.innerHTML=num;
  document.all.sssl.innerHTML=nextnum;
}

</script>


<body onload="init()">

<p align="left"><font size="4"><b>收货确认</b></font>
<div style="width:100%;txt-align:center;border:0 double gray;">
   #foreach($m in $getPreOrderH)
	<table  border="0" cellpadding="0" cellspacing="2" width="100%">
	    <tr>
	      <td height="19" width="7%">订单编号</td> <td height="19" width="15%">$m.VRECEIPTCODE</td>
	       <input name="billno" type="hidden" value="$m.PK_PREORDER">
	       <td height="19" width="7%">客户名称/代码</td> <td height="19" width="15%">$m.CUSTNAME/$m.CUSTCODE</td>
	    </tr>
	    <tr>
	      <td height="19" width="7%">下单时间</td> <td height="19" width="15%">$m.DBILLDATE</td>
	      <td height="19" width="7%">收货时间</td> <td height="19" width="15%">
	            <input name="billdate" type="text" class="login" id="billdate" value="$m.SHTIME" readonly>
		    <input type="button" value="↓" onClick="ShowDate(billdate);" class="button" name="button23" >
              </td>
	     </tr>
	    <tr>
	      <td height="19" width="7%">应收数量</td> <td height="19" width="15%"><span id="yssl">0</span></td>
	      <td height="19" width="7%">实收数量</td> <td height="19" width="15%"><span id="sssl">0</span></td>
	     </tr>
	     <tr>
	      <td height="19" width="7%">备注</td> <td height="19" colspan=3><textarea name="remark" cols="80" rows="2">$m.MEMO</textarea></td>
	    </tr>
	</table> 
  #end
	</div>
	<br>
	<div style="width:100%;txt-align:center;border:0 double gray;">
	<form id="form2">
	产品代码：<input type="text" size="16" onkeyup="presearch()"> 
	产品名称：<input type="text" size="16" onkeyup="presearch()"> 
	状态：<select  onchange="search()">
		    <option value='all' selected>全部</option>
		    <option value='N'>未收产品</option>
		    <option value='Y'>实收产品</option>
		    <option value='O'>原报产品</option>
		    </select>&nbsp;&nbsp;&nbsp;&nbsp;<input type="button" value="搜索" onclick="search()">        
	</form>
	</div>	

<!-- ['产品代码','产品名称','产品规格','下单量','按排量','备货量','发货量','实收量','状态','nc主键','0']-->

<div class="mainDiv" id="mdiv"> 
<table  class="datatable" border="0" cellpadding="0" frame="box" cellspacing="2" width="100%" id="table6">
    <tr class="fixedHeaderTr" bgcolor="#EFEFEF" id="ftr">
      <td height="19" bgcolor="#EFEFEF" width="7%" Name="st"><input type=checkbox name=checkbox value='checkbox' onclick="seldata(this)">状态</td>
      <td height="19" bgcolor="#EFEFEF" width="15%" Name="pcode" >产品代码</td>
      <td height="19" bgcolor="#EFEFEF" width="23%" Name="pname">产品名称</td>
      <td height="19" bgcolor="#EFEFEF" width="9%" Name="pspec">产品规格</td>
      <td height="19" bgcolor="#EFEFEF" width="9%" Name="prenum">下单量</td>
      <td height="19" bgcolor="#EFEFEF" width="9%" Name="salenum">应收量</td>
      <td height="19" bgcolor="#EFEFEF" width="9%" Name="costp" EditType="TextBox" DataType="Int">实收量</td>
      <td height="19" bgcolor="#EFEFEF" bgcolor="#EFEFEF" width="10%" Name="xxd" EditType="DropDownList" DataItems="{text:'小于10天',value:'小于10天'},{text:'10^20天',value:'10^20天'},{text:'20^30天',value:'20^30天'},{text:'30^40天',value:'30^40天'},{text:'大于40天',value:'大于40天'}">新鲜度</td>
      <td height="19" bgcolor="#EFEFEF" bgcolor="#EFEFEF" width="10%" Name="zl"  EditType="DropDownList" DataItems="{text:'好',value:'好'},{text:'一般',value:'一般'},{text:'差',value:'差'}">质量</td>
   
    </tr>
</table>
 </div>
<div style="width:100%;txt-align:center;border:0 double gray;">
<input type="button" value=" 保  存 " id="btnSave">&nbsp;&nbsp;&nbsp;&nbsp;<input type="button" value=" 提  交 " id="btnSave2">&nbsp;&nbsp;&nbsp;&nbsp;
<input type="button" class="login2" value=" 取  消 " name="B222" onClick="javascript:window.location='orderok.aspx';">

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<span id="pg"></span>
</div>

<script language="javascript">
var seleobj;

//单击“保存”按钮
btnSave.onclick=function()
{
   save(0,'N');	
}
//单击“提交”按钮
btnSave2.onclick=function()
{
 save(0,'Y');	
}

</script>
<script>
	 EditTables(table6);
	 toPage(1);
</script>
<form name="form_submit" method="post" action="newSalePlanSubmit.aspx" target="saveframe">
<span id="subdata"></span>
</form>
<iframe name="saveframe" src="about:blank" width="100%" height="0" noresize frameborder=0 framespacing=0 marginheight=0 marginwidth=0></iframe> 
</body>

</html>

